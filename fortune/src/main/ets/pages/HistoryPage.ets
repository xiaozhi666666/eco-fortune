import router from '@ohos.router';
import { HistoryManager, HistoryItem } from '../common/HistoryManager';

@Entry
@Component
struct HistoryPage {
  @State historyList: HistoryItem[] = [];
  private historyManager: HistoryManager = HistoryManager.getInstance();
  
  aboutToAppear() {
    this.historyList = this.historyManager.getHistoryList();
  }
  
  // åˆ é™¤åŽ†å²è®°å½•é¡¹
  deleteHistoryItem(id: string) {
    this.historyManager.deleteHistory(id);
    this.historyList = this.historyManager.getHistoryList();
  }
  
  // æ¸…ç©ºæ‰€æœ‰åŽ†å²è®°å½•
  clearAllHistory() {
    this.historyManager.clearAllHistory();
    this.historyList = this.historyManager.getHistoryList();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Button('â†')
          .fontSize(24)
          .backgroundColor(Color.Transparent)
          .fontColor('#ffd700')
          .onClick(() => {
            router.back()
          })
        
        Text('åŽ†å²è®°å½•')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#ffffff')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        Button('æ¸…ç©º')
          .fontSize(16)
          .backgroundColor(Color.Transparent)
          .fontColor('#ff6b6b')
          .onClick(() => {
            this.clearAllHistory();
            console.info('æ¸…ç©ºåŽ†å²è®°å½•');
          })
      }
      .width('100%')
      .padding(20)
      
      if (this.historyList.length === 0) {
        Column() {
          Text('ðŸ“œ')
            .fontSize(64)
            .margin({ bottom: 20 })
          
          Text('æš‚æ— åŽ†å²è®°å½•')
            .fontSize(18)
            .fontColor('#cccccc')
            .margin({ bottom: 10 })
          
          Text('å¿«åŽ»ä½“éªŒå„ç§ç®—å‘½åŠŸèƒ½å§ï¼')
            .fontSize(14)
            .fontColor('#999999')
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        Column() {
          Text(`å…±${this.historyList.length}æ¡è®°å½•`)
            .fontSize(16)
            .fontColor('#cccccc')
            .margin({ bottom: 20 })
          
          List({ space: 10 }) {
            ForEach(this.historyList, (item: HistoryItem) => {
              ListItem() {
                Row() {
                  Column({ space: 5 }) {
                    Text(`${item.title} - ${item.timestamp}`)
                      .fontSize(16)
                      .fontColor('#ffffff')
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                    
                    Text(item.content)
                      .fontSize(12)
                      .fontColor('#cccccc')
                      .maxLines(2)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                  
                  Button('åˆ é™¤')
                    .fontSize(12)
                    .backgroundColor('#ff6b6b')
                    .fontColor('#ffffff')
                    .borderRadius(15)
                    .onClick(() => {
                      this.deleteHistoryItem(item.id);
                      console.info('åˆ é™¤åŽ†å²è®°å½•ï¼š' + item.title);
                    })
                }
                .width('100%')
                .padding(15)
                .backgroundColor('#533483')
                .borderRadius(10)
              }
            }, (item: HistoryItem) => item.id)
          }
          .width('100%')
          .layoutWeight(1)
        }
        .width('100%')
        .padding(20)
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#1a1a2e')
  }
}