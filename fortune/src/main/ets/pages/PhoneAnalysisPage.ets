import router from '@ohos.router';
import { HistoryManager } from '../common/HistoryManager';

@Entry
@Component
struct PhoneAnalysisPage {
  @State phoneNumber: string = '';
  @State showResult: boolean = false;
  @State resultText: string = '';
  @State score: number = 0;
  private historyManager: HistoryManager = HistoryManager.getInstance();

  analyzePhone() {
    if (this.phoneNumber.length !== 11) {
      return;
    }
    
    this.score = Math.floor(Math.random() * 30) + 70; // 70-99åˆ†
    
    const results = [
      "æ‚¨çš„æ‰‹æœºå·ç æ•´ä½“èƒ½é‡å¹³è¡¡ï¼Œæœ‰åˆ©äºŽå„æ–¹é¢å‘å±•ã€‚æ•°å­—ç»„åˆå¯“æ„è´¢è¿äº¨é€šã€‚",
      "å·ç æ˜¾ç¤ºæ‚¨å…·æœ‰å¾ˆå¼ºçš„é¢†å¯¼èƒ½åŠ›å’Œåˆ›æ–°æ€ç»´ï¼Œäº‹ä¸šè¿åŠ¿è‰¯å¥½ã€‚",
      "ä»Žæ•°å­—åˆ†æžçœ‹ï¼Œæ‚¨çš„å·ç æœ‰åŠ©äºŽäººé™…å…³ç³»å‘å±•ï¼Œè´µäººè¿æ—ºç››ã€‚",
      "æ‰‹æœºå·ç æ•°ç†å‰ç¥¥ï¼Œé¢„ç¤ºç€ç¨³å®šå‘å±•å’ŒæŒç»­çš„å¥½è¿ã€‚å»ºè®®é•¿æœŸä½¿ç”¨ã€‚"
    ];
    
    this.resultText = results[Math.floor(Math.random() * results.length)];
    this.showResult = true;
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Button('â†')
          .fontSize(24)
          .backgroundColor(Color.Transparent)
          .fontColor('#ffd700')
          .onClick(() => {
            router.back()
          })
        
        Text('å·ç åˆ†æž')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#ffffff')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        Text('   ')
          .fontSize(24)
      }
      .width('100%')
      .padding(20)
      
      if (!this.showResult) {
        Column({ space: 30 }) {
          Text('æ‰‹æœºå·ç å‰å‡¶åˆ†æž')
            .fontSize(20)
            .fontColor('#ffd700')
            .margin({ top: 50 })
          
          TextInput({ placeholder: 'è¯·è¾“å…¥11ä½æ‰‹æœºå·ç ' })
            .width('80%')
            .height(50)
            .backgroundColor('#533483')
            .fontColor('#ffffff')
            .placeholderColor('#cccccc')
            .type(InputType.Number)
            .maxLength(11)
            .onChange((value) => {
              this.phoneNumber = value;
            })
          
          Text('åŸºäºŽæ•°å­—çš„äº”è¡Œå±žæ€§å’Œç»„åˆè§„å¾‹åˆ†æž')
            .fontSize(14)
            .fontColor('#cccccc')
            .textAlign(TextAlign.Center)
            .width('80%')
          
          Button('å¼€å§‹åˆ†æž')
            .width('60%')
            .height(50)
            .fontSize(18)
            .backgroundColor('#ffd700')
            .fontColor('#1a1a2e')
            .borderRadius(25)
            .opacity(this.phoneNumber.length === 11 ? 1.0 : 0.5)
            .onClick(() => {
              if (this.phoneNumber.length === 11) {
                this.analyzePhone();
              }
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
      } else {
        Scroll() {
          Column({ space: 20 }) {
            Text('å·ç åˆ†æžç»“æžœ')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#ffd700')
              .margin({ top: 30 })
            
            Text(`${this.phoneNumber}`)
              .fontSize(18)
              .fontColor('#ffffff')
              .margin({ bottom: 10 })
            
            // è¯„åˆ†æ˜¾ç¤º
            Column() {
              Text(`${this.score}åˆ†`)
                .fontSize(48)
                .fontWeight(FontWeight.Bold)
                .fontColor('#ffd700')
                .margin({ bottom: 10 })
              
              Text(this.score >= 85 ? 'å¤§å‰' : this.score >= 70 ? 'å‰' : 'å¹³')
                .fontSize(18)
                .fontColor(this.score >= 85 ? '#00ff7f' : this.score >= 70 ? '#ffd700' : '#cccccc')
            }
            .width('90%')
            .backgroundColor('#533483')
            .borderRadius(15)
            .padding(20)
            .margin({ bottom: 15 })
            
            Column() {
              Text(this.resultText)
                .fontSize(16)
                .fontColor('#cccccc')
                .lineHeight(24)
                .textAlign(TextAlign.Start)
                .padding(20)
            }
            .width('90%')
            .backgroundColor('#533483')
            .borderRadius(15)
            
            Button('ä¿å­˜è®°å½•')
              .width('60%')
              .height(45)
              .backgroundColor('#0f3460')
              .fontColor('#ffffff')
              .borderRadius(22)
              .onClick(() => {
                // ä¿å­˜è®°å½•åˆ°åŽ†å²
                const maskedNumber = this.phoneNumber.substring(0, 3) + '****' + this.phoneNumber.substring(7);
                this.historyManager.addHistory(
                  'phone',
                  `ðŸ“± ${maskedNumber}å·ç åˆ†æž`,
                  `è¯„åˆ†ï¼š${this.score}åˆ† - ${this.resultText}`
                );
                console.info('ä¿å­˜å·ç åˆ†æžè®°å½•ï¼š' + maskedNumber);
              })
            .width('90%')
            .margin({ top: 20 })
            
            Button('é‡æ–°æµ‹è¯•')
              .width('60%')
              .height(45)
              .fontSize(16)
              .backgroundColor('#16213e')
              .fontColor('#ffd700')
              .borderRadius(22)
              .margin({ top: 20 })
              .onClick(() => {
                this.showResult = false;
                this.phoneNumber = '';
              })
          }
          .width('100%')
          .padding(20)
        }
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#1a1a2e')
  }
}